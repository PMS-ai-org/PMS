<div class="patient-form-container">
  <mat-card class="auth-card snapshot-card" aria-labelledby="snapshotHeading">
    <div class="snapshot-header">
      <div class="avatar" [attr.aria-label]="'Initials avatar for ' + (fullName || 'patient')">{{ initials }}</div>
      <div class="title-block">
        <h2 id="snapshotHeading">Patient Snapshot</h2>
        <div class="subline">Completion {{ completionPercent }}%</div>
        <mat-progress-bar mode="determinate" [value]="completionPercent"></mat-progress-bar>
      </div>
      <span class="snapshot-spacer"></span>
      <button mat-icon-button matTooltip="Refresh" type="button" aria-label="Refresh snapshot"
        (click)="onCancel(false)">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
    <mat-divider></mat-divider>
    <div class="snapshot-sections">
      <div class="meta">
        <div class="field"><label>Name</label><span [matTooltip]="fullName || 'Not provided'">{{ fullName || '—'
            }}</span></div>
        <div class="field"><label>Age</label><span>{{ ageDisplay || '—' }}</span></div>
        <div class="field"><label>Gender</label><span>{{ form.value.gender || '—' }}</span></div>
        <div class="field"><label>Phone</label><span>{{ form.value.phone || '—' }}<button *ngIf="form.value.phone"
              mat-icon-button type="button" (click)="copy(form.value.phone,'Phone')" matTooltip="Copy phone"
              class="mini-icon"><mat-icon>content_copy</mat-icon></button></span></div>
        <div class="field"><label>Email</label><span class="truncate" [matTooltip]="form.value.email">{{
            form.value.email || '—' }}<button *ngIf="form.value.email" mat-icon-button type="button"
              (click)="copy(form.value.email,'Email')" matTooltip="Copy email"
              class="mini-icon"><mat-icon>content_copy</mat-icon></button></span></div>
        <div class="field" *ngIf="addressSummary"><label>Address</label><span class="truncate"
            [matTooltip]="addressSummary">{{ addressSummary }}</span></div>
        <div class="field" *ngIf="showBloodGroup"><label>Blood Group</label><span>{{ form.value.bloodGroup || '—'
            }}</span></div>
      </div>
      <div class="tags" *ngIf="conditionsList.length">
        <div class="tag-header">
          <label>Conditions</label>
          <div class="tag-meta" *ngIf="conditionsList.length">
            <span class="count" matTooltip="Total conditions">{{ conditionsList.length }}</span>
            <button mat-icon-button type="button" (click)="toggleConditions()" *ngIf="conditionsList.length>6"
              [matTooltip]="showAllConditions? 'Collapse' : 'Expand'">
              <mat-icon>{{ showAllConditions ? 'unfold_less' : 'unfold_more' }}</mat-icon>
            </button>
          </div>
        </div>
        <mat-chip-listbox aria-label="Conditions list">
          <mat-chip *ngFor="let c of conditionsVisible" color="primary" selected>{{ c }}</mat-chip>
        </mat-chip-listbox>
      </div>
      <div class="tags" *ngIf="medicationsList.length">
        <div class="tag-header">
          <label>Medications</label>
          <div class="tag-meta" *ngIf="medicationsList.length">
            <span class="count" matTooltip="Total medications">{{ medicationsList.length }}</span>
            <button mat-icon-button type="button" (click)="toggleMedications()" *ngIf="medicationsList.length>6"
              [matTooltip]="showAllMedications? 'Collapse' : 'Expand'">
              <mat-icon>{{ showAllMedications ? 'unfold_less' : 'unfold_more' }}</mat-icon>
            </button>
          </div>
        </div>
        <mat-chip-listbox aria-label="Medications list">
          <mat-chip *ngFor="let m of medicationsVisible" color="accent" selected>{{ m }}</mat-chip>
        </mat-chip-listbox>
      </div>

      <!-- Insurance Snapshot Block -->
      <div class="insurance-snapshot" *ngIf="insuranceForm?.get('providerId')?.value">
        <div class="ins-header">
          <div class="ins-title">Insurance</div>
          <span class="pill" [ngClass]="{'primary': insurancePriorityLabel==='Primary', 'secondary': insurancePriorityLabel==='Secondary'}">{{ insurancePriorityLabel }}</span>
        </div>
        <div class="ins-grid">
          <div class="ins-field"><label>Provider</label><span>{{ insuranceProviderName }}</span></div>
          <div class="ins-field"><label>Plan</label><span>{{ insurancePlanName }}</span></div>
          <div class="ins-field"><label>Policy #</label><span>{{ insuranceForm.value.policyNumber || '—' }}</span></div>
          <div class="ins-field" *ngIf="insuranceForm.value.memberId"><label>Member ID</label><span>{{ insuranceForm.value.memberId }}</span></div>
          <div class="ins-field"><label>Effective</label><span>{{ insuranceEffective }}</span></div>
          <div class="ins-field"><label>Expires</label><span>{{ insuranceExpiration }}</span></div>
        </div>
      </div>
    </div>
  </mat-card>

  <mat-card class="auth-card form-card compact-surface">
    <form class="compact-form" [formGroup]="form" (ngSubmit)="onSubmit()" aria-labelledby="patientFormHeading">

      <!-- Basic Details -->
      <h2 id="patientFormHeading">Patient Details</h2>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>First Name</mat-label>
          <input matInput formControlName="firstName" maxlength="64" required aria-required="true"
            aria-label="First Name" />
          <mat-error *ngIf="form.get('firstName')?.hasError('required')">
            First Name is required
          </mat-error>
          <mat-error *ngIf="form.get('firstName')?.value.length && form.get('firstName')?.value.length < 3">
            Minimum 3 characters required
          </mat-error>
          <mat-error *ngIf="form.get('firstName')?.hasError('whitespace')">
            Letters are required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Last Name</mat-label>
          <input matInput formControlName="lastName" maxlength="64" required aria-required="true"
            aria-label="Last Name" />
          <mat-error *ngIf="form.get('lastName')?.hasError('required')">
            Last Name is required
          </mat-error>
          <mat-error *ngIf="form.get('lastName')?.value.length && form.get('lastName')?.value.length < 3">
            Minimum 3 characters required
          </mat-error>
          <mat-error *ngIf="form.get('lastName')?.hasError('whitespace')">
            Letters are required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date of Birth (MM/DD/YYYY)</mat-label>
          <input matInput [matDatepicker]="picker" [max]="today" formControlName="dateOfBirth"
            aria-label="Date of Birth" (dateChange)="calculateAge()" (input)="onDobInput($event)" />
          <mat-datepicker-toggle matSuffix [for]="picker" aria-label="Choose Date of Birth"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="form.get('dateOfBirth')?.hasError('required')">DOB is required</mat-error>
          <mat-error *ngIf="form.get('dateOfBirth')?.hasError('invalidDate')">Invalid date</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Gender</mat-label>
          <mat-select formControlName="gender" aria-label="Select Gender">
            <mat-option *ngFor="let gender of genders" [value]="gender">
              {{ gender }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Responsible Person Section -->
      <h2>Responsible Person</h2>
      <div class="form-row">
        <div class="responsible-radio-group" role="radiogroup" aria-label="Is patient the responsible person?">
          <label class="group-label">Is patient the responsible person?</label>
          <mat-radio-group formControlName="responsibleIsPatient" class="inline-radios">
            <mat-radio-button value="true">No</mat-radio-button>
            <mat-radio-button value="false">Yes</mat-radio-button>
          </mat-radio-group>
        </div>
        <ng-container *ngIf="form.value.responsibleIsPatient === 'true'">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Search Patient</mat-label>
            <input type="text" matInput formControlName="responsibleSearch" [matAutocomplete]="respAuto"
              placeholder="Type to search patient" />
            <mat-progress-spinner *ngIf="responsibleSearchLoading" matSuffix diameter="20"
              mode="indeterminate"></mat-progress-spinner>
            <mat-error *ngIf="form.get('responsibleSearch')?.hasError('required')">Responsible patient search is
              required</mat-error>
          </mat-form-field>
          <mat-autocomplete #respAuto="matAutocomplete" (optionSelected)="onResponsibleOptionSelected($event)"
            [displayWith]="displayResponsible.bind(this)">
            <mat-option *ngFor="let p of responsibleFiltered$ | async" [value]="p">
              <div class="auto-item">
                <div class="name">{{ p.full_name }}</div>
                <div class="meta">{{ p.email || '—' }} • {{ p.phone || '—' }}</div>
              </div>
            </mat-option>
            <mat-option
              *ngIf="(responsibleFiltered$ | async)?.length === 0 && !responsibleSearchLoading && form.get('responsibleSearch')?.valid">No
              matches</mat-option>
          </mat-autocomplete>
        </ng-container>
      </div>
      <!-- Autocomplete replaces manual results list -->
      <div *ngIf="selectedResponsiblePatient" class="selected-chip">
        Selected: {{ selectedResponsiblePatient.full_name }} (Age: {{ selectedResponsiblePatient.age || '—' }})
      </div>

      <!-- Contact Details -->
      <h2>Contact Details</h2>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Phone (###-###-####)</mat-label>
          <input matInput type="tel" maxlength="12" formControlName="phone" (input)="onPhoneInput($event)"
            aria-label="Phone Number" />
          <mat-error *ngIf="form.get('phone')?.invalid">Invalid phone format</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" maxlength="64" aria-label="Email Address" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Address Line</mat-label>
          <input matInput formControlName="addressLine" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>City</mat-label>
          <input matInput formControlName="city" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>State</mat-label>
          <input matInput formControlName="state" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Zip</mat-label>
          <input matInput formControlName="zip" inputmode="numeric" minlength="6" maxlength="10"
            (input)="onZipInput($event)" />
          <mat-error *ngIf="zipCtrl?.value && zipCtrl?.hasError('minlength')">Minimum 6 digits</mat-error>
          <mat-error *ngIf="zipCtrl?.value && zipCtrl?.hasError('maxlength')">Maximum 10 digits</mat-error>
          <mat-error *ngIf="zipCtrl?.value && zipCtrl?.hasError('pattern')">Digits only</mat-error>
        </mat-form-field>
      </div>

      <!-- Medical Details -->
      <h2>Medical Details</h2>
      <div class="form-row medical-row compact-row">
        <ng-container *ngIf="showBloodGroup">
          <mat-form-field appearance="outline">
            <mat-label>Blood Group</mat-label>
            <mat-select formControlName="bloodGroup" aria-label="Select Blood Group">
              <mat-option *ngFor="let bg of bloodGroups" [value]="bg">{{ bg }}</mat-option>
            </mat-select>
          </mat-form-field>
        </ng-container>

        <mat-form-field appearance="outline" [matTooltip]="getAllergiesTooltip()" matTooltipPosition="above">
          <mat-label>Allergies</mat-label>
          <mat-select formControlName="allergies" multiple aria-label="Select Allergies">
            <mat-option *ngFor="let allergy of allergyOptions" [value]="allergy">
              {{ allergy }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" [matTooltip]="getConditionsTooltip()" matTooltipPosition="above">
          <mat-label>Conditions</mat-label>
          <mat-select formControlName="conditions" multiple aria-label="Select Conditions">
            <mat-option *ngFor="let data of conditions" [value]="data">{{ data }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="compact-field" appearance="outline" [matTooltip]="getMedicationsTooltip()"
          matTooltipPosition="above">
          <mat-label>Medications</mat-label>
          <mat-select formControlName="medications" multiple aria-label="Select Medications">
            <mat-option *ngFor="let data of medications" [value]="data">{{ data }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="notes-field">
          <mat-label>Notes</mat-label>
          <textarea matInput rows="3" formControlName="notes" aria-label="notes"></textarea>
        </mat-form-field>
      </div>

      <!-- Insurance Section (separate form) -->
      <h2>Insurance Details</h2>
      <form [formGroup]="insuranceForm" class="insurance-form" aria-label="Insurance form">
        <!-- Row 1: Policy Holder / Provider / Policy Number -->
        <div class="form-row stage-row">
          <mat-form-field appearance="outline" class="policy-holder-field">
            <mat-label>Policy Holder</mat-label>
            <mat-select formControlName="policyHolderType">
              <mat-option value="Self">Self</mat-option>
              <mat-option
                *ngIf="showResponsibleHolderOption && selectedResponsiblePatient && (selectedResponsiblePatient.age || 0) >= 18"
                [value]="selectedResponsiblePatient.id">{{ selectedResponsiblePatient.full_name }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="provider-field">
            <mat-label>Provider</mat-label>
            <mat-select formControlName="providerId" placeholder="Select Provider">
              <mat-option *ngFor="let p of insuranceProviders" [value]="p.id">{{ p.name }}</mat-option>
            </mat-select>
            <mat-error *ngIf="insuranceForm.get('providerId')?.hasError('required')">Provider required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="policy-number-field">
            <mat-label>Policy Number</mat-label>
            <input matInput formControlName="policyNumber" maxlength="32"
              [disabled]="!insuranceForm.value.providerId" />
            <mat-error *ngIf="insuranceForm.get('policyNumber')?.hasError('required')">Policy number
              required</mat-error>
          </mat-form-field>
        </div>

        <!-- Row 2: Plan / Member ID / Priority (provider selected) -->
        <div class="form-row stage-row" *ngIf="insuranceForm.value.providerId">
          <mat-form-field appearance="outline" class="plan-field">
            <mat-label>Plan</mat-label>
            <mat-select formControlName="planId" placeholder="Select Plan">
              <mat-option *ngFor="let plan of insurancePlans" [value]="plan.id">{{ plan.name }}</mat-option>
            </mat-select>
            <mat-error *ngIf="insuranceForm.get('planId')?.hasError('required')">Plan required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="member-id-field">
            <mat-label>Member ID</mat-label>
            <input matInput formControlName="memberId" maxlength="32" [disabled]="!insuranceForm.value.planId" />
            <mat-error *ngIf="insuranceForm.get('memberId')?.hasError('required')">Member ID required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="priority-field">
            <mat-label>Priority</mat-label>
            <mat-select formControlName="priority">
              <mat-option value="1">Primary</mat-option>
              <mat-option value="2">Secondary</mat-option>
            </mat-select>
            <mat-error *ngIf="insuranceForm.get('priority')?.hasError('required')">Priority required</mat-error>
          </mat-form-field>
        </div>

        <!-- Row 3: Effective / Expiration Dates + Save (plan selected) -->
        <div class="form-row stage-row" *ngIf="insuranceForm.value.planId">
          <mat-form-field appearance="outline" class="effective-date-field">
            <mat-label>Effective Date</mat-label>
            <input matInput [matDatepicker]="effectivePicker" formControlName="effectiveDate" />
            <mat-datepicker-toggle matSuffix [for]="effectivePicker"></mat-datepicker-toggle>
            <mat-datepicker #effectivePicker></mat-datepicker>
            <mat-error *ngIf="insuranceForm.get('effectiveDate')?.hasError('required')">Effective date
              required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="expiration-date-field">
            <mat-label>Expiration Date</mat-label>
            <input matInput [matDatepicker]="expirationPicker" formControlName="expirationDate" />
            <mat-datepicker-toggle matSuffix [for]="expirationPicker"></mat-datepicker-toggle>
            <mat-datepicker #expirationPicker></mat-datepicker>
            <mat-error *ngIf="insuranceForm.get('expirationDate')?.hasError('required')">Expiration date
              required</mat-error>
          </mat-form-field>
        </div>
      </form>

      <!-- Submit -->
      <div class="form-actions">
        <button mat-stroked-button type="button" (click)="onCancel(false)">Reset</button>
        <button mat-button type="button" (click)="onCancel(true)">Cancel</button>
        <span class="spacer"></span>
        <button mat-flat-button *ngIf="!patientId" color="primary" type="button" (click)="saveAndAddAnother()"
          [disabled]="savingAnother || submitting">
          <mat-progress-spinner *ngIf="savingAnother" diameter="18" mode="indeterminate"></mat-progress-spinner>
          <span *ngIf="!savingAnother">Save & Add Another</span>
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="submitting || savingAnother">
          <mat-progress-spinner *ngIf="submitting" diameter="18" mode="indeterminate"></mat-progress-spinner>
          <span *ngIf="!submitting">Save</span>
        </button>
      </div>
    </form>
    <div class="loading-overlay" *ngIf="submitting || savingAnother">
      <mat-progress-spinner diameter="60" mode="indeterminate"></mat-progress-spinner>
    </div>
  </mat-card>
</div>

<!-- Under Age Warning Dialog -->
<ng-template #underAgeTpl>
  <h2 mat-dialog-title>Under Age Warning</h2>
  <mat-dialog-content>The selected responsible person is under 18. Please choose an adult.</mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>