<form [formGroup]="doctorForm" (ngSubmit)="onSubmit()" class="p-4 grid gap-4">

  <div>
    <mat-form-field appearance="outline">
      <mat-label>Role</mat-label>
      <mat-select formControlName="roleId" (selectionChange)="onRoleChange($event.value)">
        @for (role of roles; track $index) {
        <mat-option [value]="role.roleId">
          {{ role.roleName }}
        </mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  @if (roleText?.length > 0) {
  <div>
    <div>
      <mat-form-field appearance="outline">
        <mat-label>Username</mat-label>
        <input matInput formControlName="username">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" type="email">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Full Name</mat-label>
        <input matInput formControlName="fullName">
      </mat-form-field>
    </div>
    <div>
      <mat-form-field appearance="outline">
        <mat-label>Phone Number</mat-label>
        <input matInput formControlName="phoneNumber">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Specialization</mat-label>
        <input matInput formControlName="specialization">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Clinic</mat-label>
        <mat-select formControlName="clinicId" (selectionChange)="onClinicChange($event.value)">
          <mat-option *ngFor="let clinic of clinics" [value]="clinic.id">
            {{ clinic.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Multi Select Sites -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Select Sites</mat-label>
      <mat-select multiple (selectionChange)="onSitesChange($event.value)">
        <mat-option *ngFor="let site of sites" [value]="site.id">
          {{ site.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <table mat-table [dataSource]="sitesDataSource" class="mat-elevation-z8 w-full mt-4">

      <!-- Site Name Column -->
      <ng-container matColumnDef="siteName">
        <th mat-header-cell *matHeaderCellDef>Site</th>
        <td mat-cell *matCellDef="let siteGroup">{{ siteGroup.get('siteName')?.value }}</td>
      </ng-container>

      <!-- Features Column -->
      <ng-container matColumnDef="features">
        <th mat-header-cell *matHeaderCellDef>Features</th>
        <td mat-cell *matCellDef="let siteGroup">
          <table mat-table [dataSource]="siteGroup.get('features').controls" class="w-full">

            <!-- Feature Name -->
            <ng-container matColumnDef="featureName">
              <th mat-header-cell *matHeaderCellDef>Feature</th>
              <td mat-cell *matCellDef="let feature">{{ feature.get('featureName')?.value }}</td>
            </ng-container>

            <!-- Can View -->
            <ng-container matColumnDef="canView">
              <th mat-header-cell *matHeaderCellDef>View</th>
              <td mat-cell *matCellDef="let feature">
                <mat-checkbox [formControl]="feature.get('canView')"></mat-checkbox>
              </td>
            </ng-container>

            <!-- Can Add -->
            <ng-container matColumnDef="canAdd">
              <th mat-header-cell *matHeaderCellDef>Add</th>
              <td mat-cell *matCellDef="let feature">
                <mat-checkbox [formControl]="feature.get('canAdd')"></mat-checkbox>
              </td>
            </ng-container>

            <!-- Can Edit -->
            <ng-container matColumnDef="canEdit">
              <th mat-header-cell *matHeaderCellDef>Edit</th>
              <td mat-cell *matCellDef="let feature">
                <mat-checkbox [formControl]="feature.get('canEdit')"></mat-checkbox>
              </td>
            </ng-container>

            <!-- Can Delete -->
            <ng-container matColumnDef="canDelete">
              <th mat-header-cell *matHeaderCellDef>Delete</th>
              <td mat-cell *matCellDef="let feature">
                <mat-checkbox [formControl]="feature.get('canDelete')"></mat-checkbox>
              </td>
            </ng-container>

            <!-- Header & Rows for Nested Table -->
            <tr mat-header-row *matHeaderRowDef="['featureName','canView','canAdd','canEdit','canDelete']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['featureName','canView','canAdd','canEdit','canDelete']"></tr>
          </table>
        </td>
      </ng-container>

      <!-- Main Table Header & Rows -->
      <tr mat-header-row *matHeaderRowDef="['siteName','features']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['siteName','features']"></tr>
    </table>

    <div>
      <button mat-raised-button color="primary" type="submit">Register Doctor</button>
    </div>
  </div>
  }
</form>