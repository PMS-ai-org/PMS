<mat-horizontal-stepper [linear]="true" #stepper>
  <!-- Step 1: Doctor Info -->
  <mat-step [stepControl]="doctorForm">
    <form [formGroup]="doctorForm" class="m-1">
      <ng-template matStepLabel>Doctor Information</ng-template>

      <!-- Role -->
      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Role</mat-label>
        <mat-select formControlName="roleId" (selectionChange)="onRoleChange($event.value)">
          @for (role of roles; track $index) {
          <mat-option [value]="role.roleId">{{ role.roleName }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Full Name</mat-label>
        <input matInput formControlName="fullName">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" type="email">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Phone Number</mat-label>
        <input matInput formControlName="phoneNumber">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Specialization</mat-label>
        <input matInput formControlName="specialization">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Role</mat-label>
        <mat-select formControlName="clinicId" (selectionChange)="onClinicChange($event.value)">
          @for (clinic of clinics; track $index) {
          <mat-option [value]="clinic.id">{{ clinic.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Multi Select Sites -->
      <mat-form-field appearance="outline" class="w-full mr-1">
        <mat-label>Select Sites</mat-label>
        <mat-select multiple (selectionChange)="onSitesChange($event.value)">
          @for (site of sites; track $index) {
          <mat-option [value]="site.id">
            {{ site.name }}
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div>
        <button mat-raised-button color="primary" matStepperNext>Next</button>
      </div>
    </form>
  </mat-step>

  <!-- Step 2: Assign Sites & Features -->
  <mat-step [stepControl]="doctorForm">

    <form [formGroup]="doctorForm" (ngSubmit)="onSubmit()">
      <div class="flex justify-between mt-4">
        <button mat-raised-button matStepperPrevious>Back</button>
        <button mat-raised-button color="primary" type="submit">Register Doctor</button>
      </div>
      <ng-template matStepLabel>Assign Sites</ng-template>

      <!-- Table for Sites & Features -->
      <table mat-table [dataSource]="sitesDataSource" class="mat-elevation-z8 w-full mt-4">
        <!-- Site Name -->
        <ng-container matColumnDef="siteName">
          <th mat-header-cell *matHeaderCellDef>Site</th>
          <td mat-cell *matCellDef="let siteGroup">{{ siteGroup.get('siteName')?.value }}</td>
        </ng-container>

        <!-- Features Table -->
        <ng-container matColumnDef="features">
          <th mat-header-cell *matHeaderCellDef>Features</th>
          <td mat-cell *matCellDef="let siteGroup">
            <table mat-table [dataSource]="siteGroup.get('features').controls" class="w-full">
              <ng-container matColumnDef="featureName">
                <th mat-header-cell *matHeaderCellDef>Feature</th>
                <td mat-cell *matCellDef="let feature">{{ feature.get('featureName')?.value }}</td>
              </ng-container>

              <ng-container matColumnDef="canView">
                <th mat-header-cell *matHeaderCellDef>View</th>
                <td mat-cell *matCellDef="let feature">
                  <mat-checkbox [formControl]="feature.get('canView')"></mat-checkbox>
                </td>
              </ng-container>

              <ng-container matColumnDef="canAdd">
                <th mat-header-cell *matHeaderCellDef>Add</th>
                <td mat-cell *matCellDef="let feature">
                  <mat-checkbox [formControl]="feature.get('canAdd')"></mat-checkbox>
                </td>
              </ng-container>

              <ng-container matColumnDef="canEdit">
                <th mat-header-cell *matHeaderCellDef>Edit</th>
                <td mat-cell *matCellDef="let feature">
                  <mat-checkbox [formControl]="feature.get('canEdit')"></mat-checkbox>
                </td>
              </ng-container>

              <ng-container matColumnDef="canDelete">
                <th mat-header-cell *matHeaderCellDef>Delete</th>
                <td mat-cell *matCellDef="let feature">
                  <mat-checkbox [formControl]="feature.get('canDelete')"></mat-checkbox>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['featureName','canView','canAdd','canEdit','canDelete']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['featureName','canView','canAdd','canEdit','canDelete']"></tr>
            </table>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['siteName','features']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['siteName','features']"></tr>
      </table>


    </form>
  </mat-step>
</mat-horizontal-stepper>